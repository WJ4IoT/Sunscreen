alias: sunscreen
description: check to see if sunscreen may and/or needs to to be opened or closeds
trigger:
  - platform: state
    entity_id:
      - binary_sensor.sunscreen_valid_wind
      - binary_sensor.sunscreen_no_rain_next_hour
    id: sunscreen_delay_action_no
    from: "off"
    to: "on"
  - platform: state
    id: sunscreen_delay_action_yes
    entity_id:
      - binary_sensor.sunscreen_valid_azimuth
      - binary_sensor.sunscreen_valid_elevation
      - binary_sensor.sunscreen_valid_irradiance
      - binary_sensor.sunscreen_valid_months
  - platform: state
    entity_id:
      - binary_sensor.sunscreen_valid_wind
      - binary_sensor.sunscreen_no_rain_next_hour
    id: sunscreen_delay_action_yes
    from: "on"
    to: "off"
  - platform: state
    entity_id:
      - timer.sunscreen_delay
    id: sunscreen_delay_action_end
    from: active
    to: idle
condition: []
action:
  - choose:
      - conditions:
          - condition: and
            conditions:
              - condition: state
                entity_id: binary_sensor.sunscreen_valid_months
                state: "on"
              - condition: state
                entity_id: binary_sensor.sunscreen_valid_elevation
                state: "on"
              - condition: state
                entity_id: binary_sensor.sunscreen_valid_azimuth
                state: "on"
              - condition: state
                entity_id: binary_sensor.sunscreen_valid_irradiance
                state: "on"
              - condition: state
                entity_id: binary_sensor.sunscreen_valid_wind
                state: "on"
              - condition: state
                entity_id: binary_sensor.sunscreen_no_rain_next_hour
                state: "on"
        sequence:
          - service: input_boolean.turn_on
            data: {}
            target:
              entity_id:
                - input_boolean.sunscreen_conditions_close_request
    default:
      - service: input_boolean.turn_off
        data: {}
        target:
          entity_id:
            - input_boolean.sunscreen_conditions_close_request
  - if:
      - condition: template
        value_template: >-
          {{ states('input_boolean.sunscreen_conditions_close') ==
          states('input_boolean.sunscreen_conditions_close_request') }}
    then:
      - stop: ""
    else: []
  - choose:
      - conditions:
          - condition: trigger
            id: sunscreen_delay_action_no
        sequence: []
      - conditions:
          - condition: and
            conditions:
              - condition: trigger
                id: sunscreen_delay_action_yes
              - condition: state
                entity_id: timer.sunscreen_delay
                state: idle
              - condition: state
                entity_id: input_boolean.sunscreen_set_manual
                state: "off"
        sequence: []
      - conditions:
          - condition: and
            conditions:
              - condition: trigger
                id: sunscreen_delay_action_end
              - condition: state
                entity_id: input_boolean.sunscreen_set_manual
                state: "off"
        sequence: []
    default:
      - stop: Not defined
        error: false
  - if:
      - condition: state
        entity_id: input_boolean.sunscreen_conditions_close_request
        state: "on"
    then:
      - service: input_boolean.turn_on
        data: {}
        target:
          entity_id:
            - input_boolean.sunscreen_conditions_close
            - input_boolean.sunscreen_fake
      - device_id: YOUR_SUNSCREEN_ID
        domain: cover
        entity_id: cover.zonnescherm
        type: close
    else:
      - service: input_boolean.turn_off
        data: {}
        target:
          entity_id:
            - input_boolean.sunscreen_conditions_close
            - input_boolean.sunscreen_fake
      - device_id: YOUR_SUNSCREEN_ID
        domain: cover
        entity_id: cover.zonnescherm
        type: open
  - service: timer.start
    data:
      duration: "00:45:00"
    target:
      entity_id: timer.sunscreen_delay
mode: single
